<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .option-btn.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white;
        }

        .option-btn.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white;
        }

        .option-btn.selected {
            ring: 4px;
            ring-color: #facc15; /* yellow-400 */
        }
        .leaderboard-entry.first { background-color: #fbbf24; color: #422006; } /* amber-400 */
        .leaderboard-entry.second { background-color: #d1d5db; color: #1f2937; } /* gray-300 */
        .leaderboard-entry.third { background-color: #fcd34d; color: #78350f; } /* amber-300 */

    </style>
</head>

<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="loading-view" class="text-center">
        <h1 class="text-3xl font-bold">Connecting to game...</h1>
    </div>

    <!-- Main Container for the Game -->
    <div id="game-container" class="w-full max-w-4xl hidden">

        <!-- =================================================================== -->
        <!-- == PLAYER VIEW ==================================================== -->
        <!-- =================================================================== -->
        <div id="player-view" class="hidden w-full max-w-2xl mx-auto text-center">
            <!-- Player HUD -->
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg font-semibold" id="player-question-counter">1 / 10</div>
                <div id="player-timer-display" class="text-2xl font-bold">10</div>
                <div class="text-lg font-semibold">Score: <span id="player-score">0</span></div>
            </div>
            <!-- Question Text -->
            <div class="bg-gray-800 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                <h1 id="player-question-text" class="text-2xl font-bold">Loading question...</h1>
            </div>
            <!-- Answer Options -->
            <div id="player-options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- =================================================================== -->
        <!-- == HOST VIEW ====================================================== -->
        <!-- =================================================================== -->
        <div id="host-view" class="hidden w-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Participants -->
                <div class="lg:col-span-1 bg-gray-800 p-4 rounded-lg">
                    <h2 class="text-xl font-bold mb-3 border-b border-gray-700 pb-2">Participants (<span id="host-participant-count">0</span>)</h2>
                    <ul id="host-participant-list" class="space-y-2 overflow-y-auto max-h-96">
                        <!-- Participant items will be injected here -->
                    </ul>
                </div>

                <!-- Center Column: Game Content -->
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg">
                    <!-- Host HUD -->
                    <div class="flex justify-between items-center mb-4 text-lg">
                        <span>Question: <span id="host-question-counter">--</span></span>
                        <span class="font-bold">Room ID: <span id="host-room-id" class="font-mono text-indigo-400"></span></span>
                        <span>Time Left: <span id="host-timer-display" class="font-bold">--</span></span>
                    </div>
                    <!-- Question Display -->
                    <div id="host-question-display" class="text-center">
                         <div class="bg-gray-900 p-6 rounded-lg mb-6 min-h-[100px] flex items-center justify-center">
                            <h1 id="host-question-text" class="text-2xl font-bold">Waiting to start the game...</h1>
                        </div>
                        <div id="host-options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- =================================================================== -->
        <!-- == SHARED VIEWS (Modals / Overlays) =============================== -->
        <!-- =================================================================== -->
        <div id="results-view" class="hidden absolute inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center text-center p-4">
            <h2 id="result-title" class="text-5xl font-bold mb-4">Round Over!</h2>
            <p class="text-2xl mb-8">The correct answer was: <strong id="correct-answer-text" class="text-green-400"></strong></p>
            <div class="w-full max-w-md">
                 <h3 class="text-2xl font-semibold mb-3">Leaderboard</h3>
                 <div id="results-leaderboard" class="space-y-2 text-left bg-gray-800 p-4 rounded-lg"></div>
            </div>
            <!-- Host-only button -->
            <button id="next-question-btn" class="hidden mt-8 bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 text-xl">Next Question</button>
            <!-- Player-only text -->
            <p id="waiting-for-host-text" class="hidden text-gray-400 mt-8 text-xl">Waiting for the host to continue...</p>
        </div>

        <div id="final-score-view" class="hidden absolute inset-0 bg-gray-900 bg-opacity-95 flex flex-col items-center justify-center text-center p-4">
            <h2 class="text-6xl font-bold mb-6">Game Over!</h2>
            <div class="w-full max-w-md">
                 <h3 class="text-3xl font-semibold mb-4">Final Scores</h3>
                 <div id="final-leaderboard" class="space-y-2 text-left bg-gray-800 p-4 rounded-lg"></div>
            </div>
            <a href="index.html" class="inline-block mt-10 bg-indigo-600 text-white font-semibold py-4 px-8 rounded-md hover:bg-indigo-700 text-2xl">Play Again</a>
        </div>

    </div>


    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:3000/');

        // --- State ---
        let isHost = sessionStorage.getItem('isHost') === 'true';
        let roomId = sessionStorage.getItem('roomId');
        let mySocketId = null;
        let currentTimer;

        // --- UI Elements ---
        const allViews = ['loading-view', 'game-container', 'player-view', 'host-view', 'results-view', 'final-score-view'];
        const gameContainer = document.getElementById('game-container');

        // Player UI
        const playerView = document.getElementById('player-view');
        const playerQuestionCounter = document.getElementById('player-question-counter');
        const playerTimerDisplay = document.getElementById('player-timer-display');
        const playerScore = document.getElementById('player-score');
        const playerQuestionText = document.getElementById('player-question-text');
        const playerOptionsGrid = document.getElementById('player-options-grid');

        // Host UI
        const hostView = document.getElementById('host-view');
        const hostParticipantCount = document.getElementById('host-participant-count');
        const hostParticipantList = document.getElementById('host-participant-list');
        const hostQuestionCounter = document.getElementById('host-question-counter');
        const hostRoomId = document.getElementById('host-room-id');
        const hostTimerDisplay = document.getElementById('host-timer-display');
        const hostQuestionText = document.getElementById('host-question-text');
        const hostOptionsGrid = document.getElementById('host-options-grid');

        // Shared UI
        const resultsView = document.getElementById('results-view');
        const resultTitle = document.getElementById('result-title');
        const correctAnswerText = document.getElementById('correct-answer-text');
        const resultsLeaderboard = document.getElementById('results-leaderboard');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const waitingForHostText = document.getElementById('waiting-for-host-text');
        const finalScoreView = document.getElementById('final-score-view');
        const finalLeaderboard = document.getElementById('final-leaderboard');

        // --- Core Render Function ---
        function render(state) {
            console.log("Received State: ", state);
            mySocketId = state.yourSocketId;
            
            // Hide all views initially, except the main container
            allViews.forEach(id => document.getElementById(id).classList.add('hidden'));
            gameContainer.classList.remove('hidden');


            // Update shared elements
            hostRoomId.textContent = state.roomId;
            updateParticipantList(state.participants);
            updateLeaderboard(resultsLeaderboard, state.participants); // Update results leaderboard

            // Timer
            clearInterval(currentTimer);
            if(state.gameState === 'question' && state.question) {
                startTimer(state.question.timeLimit);
            } else {
                playerTimerDisplay.textContent = '-';
                hostTimerDisplay.textContent = '-';
            }

            // Main view logic
            switch(state.gameState) {
                case 'question':
                    renderQuestionView(state);
                    break;
                case 'results':
                    renderResultsView(state);
                    break;
                case 'end':
                    renderFinalView(state);
                    break;
                default: // lobby or error
                    gameContainer.classList.add('hidden');
                    document.getElementById('loading-view').classList.remove('hidden');
                    document.getElementById('loading-view').textContent = state.error || "Waiting for game to start...";
                    break;
            }
        }

        function renderQuestionView(state) {
            const { question, currentQuestionIndex, totalQuestions } = state;
            if (isHost) {
                hostView.classList.remove('hidden');
                hostQuestionCounter.textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
                hostQuestionText.textContent = question.questionText;
                renderOptions(hostOptionsGrid, question, true); // Host sees correct answer
            } else {
                playerView.classList.remove('hidden');
                const me = state.participants.find(p => p.socket_id === mySocketId);
                playerScore.textContent = me ? me.score : 0;
                playerQuestionCounter.textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
                playerQuestionText.textContent = question.questionText;
                renderOptions(playerOptionsGrid, question, false); // Player does not see correct answer
            }
        }

        function renderResultsView(state) {
            const { question } = state;
            const correctAnswer = question.options[question.correctAnswerIndex];
            correctAnswerText.textContent = correctAnswer.text;
            
            updateLeaderboard(resultsLeaderboard, state.participants);
            resultsView.classList.remove('hidden');

            if (isHost) {
                nextQuestionBtn.classList.remove('hidden');
                waitingForHostText.classList.add('hidden');
            } else {
                nextQuestionBtn.classList.add('hidden');
                waitingForHostText.classList.remove('hidden');
            }
        }

        function renderFinalView(state) {
            updateLeaderboard(finalLeaderboard, state.participants, true);
            finalScoreView.classList.remove('hidden');
        }

        // --- Helper Render Functions ---
        function updateParticipantList(participants) {
            hostParticipantList.innerHTML = '';
            hostParticipantCount.textContent = participants.length;
            participants.forEach(p => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                const statusColor = p.isOnline ? 'bg-green-500' : 'bg-gray-500';
                const answeredCheck = p.answered ? '✔' : '';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-2.5 h-2.5 ${statusColor} rounded-full mr-3"></span>
                        <span class="font-medium">${p.user_name} ${p.role === 'host' ? '(Host)' : ''}</span>
                    </div>
                    <span class="text-green-400 font-bold">${p.role === 'player' ? answeredCheck : ''}</span>
                `;
                hostParticipantList.appendChild(li);
            });
        }

        function renderOptions(gridElement, question, showCorrect) {
            gridElement.innerHTML = '';
            const optionColors = ['bg-indigo-600', 'bg-purple-600', 'bg-pink-600', 'bg-teal-600'];
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = `option-btn ${optionColors[index % 4]} p-4 rounded-lg font-semibold text-lg hover:brightness-110 transition-all w-full text-left`;
                
                if (showCorrect) { // For host view or results view
                    button.disabled = true;
                    if (option.isCorrect || index === question.correctAnswerIndex) {
                        button.classList.add('correct');
                    }
                } else { // For player view during question
                    button.onclick = () => selectAnswer(index);
                }
                gridElement.appendChild(button);
            });
        }
        
        function updateLeaderboard(element, participants, isFinal = false) {
            element.innerHTML = '';
            const sorted = [...participants]
                .filter(p => p.role === 'player')
                .sort((a, b) => b.score - a.score);
            
            if (sorted.length === 0) {
                element.innerHTML = '<p class="text-gray-400 text-center">No players on leaderboard yet.</p>';
                return;
            }

            sorted.forEach((player, index) => {
                const entry = document.createElement('div');
                let rankClass = 'bg-gray-700';
                if (isFinal) {
                    if (index === 0) rankClass = 'first';
                    if (index === 1) rankClass = 'second';
                    if (index === 2) rankClass = 'third';
                }
                entry.className = `leaderboard-entry flex justify-between items-center text-lg p-2 rounded font-medium ${rankClass}`;
                entry.innerHTML = `
                    <span>#${index + 1} ${player.user_name}</span>
                    <span class="font-bold">${player.score} pts</span>
                `;
                element.appendChild(entry);
            });
        }

        function startTimer(duration) {
            let timeLeft = duration;
            const update = () => {
                playerTimerDisplay.textContent = timeLeft;
                hostTimerDisplay.textContent = timeLeft;
            };
            update();
            currentTimer = setInterval(() => {
                timeLeft--;
                update();
                if (timeLeft <= 0) {
                    clearInterval(currentTimer);
                }
            }, 1000);
        }

        // --- Event Handlers ---
        function selectAnswer(optionIndex) {
            // Disable all buttons after one is clicked
            document.querySelectorAll('#player-options-grid .option-btn').forEach((btn, index) => {
                btn.disabled = true;
                if (index === optionIndex) {
                    btn.classList.add('selected', 'ring-yellow-400');
                }
            });
            socket.emit('submit-answer', { roomId, optionIndex });
        }
        
        nextQuestionBtn.onclick = () => {
            socket.emit('request-next-question', roomId);
        };


        // --- Socket Listeners ---
        socket.on('connect', () => {
            console.log('Connected to server!');
        });
        
        socket.on('game-update', (state) => {
            render(state);
        });

        socket.on('error-message', (message) => {
            alert(`Error: ${message}`);
            window.location.href = 'index.html';
        });

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!roomId) {
                alert('No room ID found. Returning to start.');
                window.location.href = 'index.html';
                return;
            }
            // Announce that this client has loaded the page and is ready for the game state.
            socket.emit('rejoin-game', { roomId });
        });
    </script>
</body>

</html>
